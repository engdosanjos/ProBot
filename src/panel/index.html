<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Painel — Live Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0f1115; --card:#151924; --muted:#9aa4b2; --fg:#e8eef6; --good:#29d; --green:#20c997; --red:#ff6b6b; }
    body { background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; }
    header { padding:12px 16px; background:#0d1320; position:sticky; top:0; z-index:1; border-bottom:1px solid #1f2433}
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .kpi { background:var(--card); padding:10px 12px; border-radius:8px; min-width:130px; }
    .kpi b { font-size:18px; display:block; }
    .kpi small { color:var(--muted) }

    main { padding:16px; display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
    @media (max-width: 1000px) { main { grid-template-columns: 1fr; } }

    .card { background:var(--card); border-radius:10px; padding:12px; }
    h2 { margin: 0 0 8px 0; font-size:18px; }
    table { width:100%; border-collapse:collapse; }
    th, td { font-size:13px; padding:6px 8px; border-bottom:1px solid #202637; text-align:left; }
    th { color:var(--muted); font-weight:600; }
    .muted { color:var(--muted) }
    .pill { padding:2px 6px; border-radius:999px; font-size:12px; }
    .pill.green { background:rgba(32,201,151,.15); color:var(--green) }
    .pill.red   { background:rgba(255,107,107,.15); color:var(--red) }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }

    .probrow { display:flex; gap:6px; flex-wrap:wrap }
    .chip { background:#1c2336; border:1px solid #27304a; border-radius:8px; padding:4px 6px; font-size:12px }
    a { color:#7abaff; text-decoration:none }
    a:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <header>
    <div class="row" id="kpis">
      <div class="kpi"><small>Jogos monitorados</small><b id="k_live">0</b></div>
      <div class="kpi"><small>Entradas abertas</small><b id="k_open">0</b></div>
      <div class="kpi"><small>Greens</small><b id="k_green" class="green">0</b></div>
      <div class="kpi"><small>Reds</small><b id="k_red" class="red">0</b></div>
      <div class="kpi"><small>Assertividade</small><b id="k_acc">0%</b></div>
      <div class="kpi"><small>PNL</small><b id="k_pnl" class="mono">0.00u</b></div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Jogos em andamento</h2>
      <table id="tbl_live">
        <thead>
          <tr>
            <th>Jogo</th><th>Placar</th><th>Min</th><th>Status</th>
            <th class="muted">Pressão (H/A)</th>
            <th>Prob. de Gol (5–25')</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Entradas abertas</h2>
      <table id="tbl_open">
        <thead>
          <tr>
            <th>Jogo</th><th>Janela</th><th>Lado</th><th>Prob</th><th>Aberta em</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2 style="margin-top:14px">Últimas entradas encerradas</h2>
      <table id="tbl_recent">
        <thead>
          <tr>
            <th>Jogo</th><th>Janela</th><th>Lado</th><th>Prob</th><th>Resultado</th><th>PNL</th><th>Fechada</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    async function j(url){ const r = await fetch(url); return r.json(); }
    function fmtPct(x){
      const v = Number.isFinite(x) ? x : 0;
      return (Math.round(v*1000)/10)+'%';
    }
    function fmtTs(ts){
      if(!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleTimeString();
    }
    const pick = (...ks) => (o)=> ks.find(k => o && o[k] != null);

    function renderLive(rows){
      const tb = document.querySelector('#tbl_live tbody');
      tb.innerHTML = '';
      for(const r of rows){
        const probs = (r.windows || []).map(w => {
          const W = w.window_min ?? w.window ?? '?';
          const P = w.prob ?? 0;
          return `<span class="chip"><b>${W}'</b> ${fmtPct(P)}</span>`;
        }).join(' ');
        const ph = (r.pressure?.home ?? 0);
        const pa = (r.pressure?.away ?? 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div><b>${r.home}</b> x <b>${r.away}</b><br><span class="muted">${r.league||''}</span></div></td>
          <td class="mono">${r.goals_home ?? 0} - ${r.goals_away ?? 0}</td>
          <td class="mono">${r.minute ?? ''}</td>
          <td>${r.status||''}</td>
          <td class="mono">${ph}/${pa}</td>
          <td><div class="probrow">${probs || '<span class="muted">sem previsão</span>'}</div></td>
          <td>${r.url ? `<a href="${r.url}" target="_blank" rel="noopener">detalhe</a>` : ''}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function renderSnapshot(s){
      document.getElementById('k_live').textContent  = s.live ?? 0;
      document.getElementById('k_open').textContent  = s.open ?? 0;
      document.getElementById('k_green').textContent = s.counters?.greens ?? 0;
      document.getElementById('k_red').textContent   = s.counters?.reds ?? 0;
      document.getElementById('k_acc').textContent   = (s.counters?.accuracy_pct ?? 0) + '%';
      document.getElementById('k_pnl').textContent   = (s.counters?.pnl ?? 0).toFixed(2) + 'u';
    }

    function renderOpen(rows){
      const tb = document.querySelector('#tbl_open tbody');
      tb.innerHTML = '';
      for(const r of rows){
        const w  = r.window_min ?? r.window ?? '?';
        const ts = r.created_at ?? r.created_ts ?? r.ts ?? null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${r.home||''}</b> x <b>${r.away||''}</b><br><span class="muted">${r.league||''}</span></td>
          <td class="mono">${w}'</td>
          <td>${r.side || '-'}</td>
          <td class="mono">${fmtPct(r.prob ?? 0)}</td>
          <td class="mono">${fmtTs(ts)}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function renderRecent(rows){
      const tb = document.querySelector('#tbl_recent tbody');
      tb.innerHTML = '';
      for(const r of rows){
        const w   = r.window_min ?? r.window ?? '?';
        const ok  = (r.status === 'green' || r.status === 'won');
        const end = r.closed_at ?? r.settle_minute ?? r.created_ts ?? r.ts ?? null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${r.home||''}</b> x <b>${r.away||''}</b><br><span class="muted">${r.league||''}</span></td>
          <td class="mono">${w}'</td>
          <td>${r.side||'-'}</td>
          <td class="mono">${fmtPct(r.prob ?? 0)}</td>
          <td><span class="pill ${ok?'green':'red'}">${ok ? 'GREEN' : 'RED'}</span></td>
          <td class="mono">${(r.pnl ?? 0).toFixed(2)}u</td>
          <td class="mono">${fmtTs(end)}</td>
        `;
        tb.appendChild(tr);
      }
    }

    async function tick(){
      try{
        const [live, snap, open, recent] = await Promise.all([
          j('/api/live'), j('/api/snapshot'), j('/api/open-signals'), j('/api/recent-signals')
        ]);
        if(live.ok) renderLive(live.rows);
        if(snap.ok) renderSnapshot(snap);
        if(open.ok) renderOpen(open.rows);
        if(recent.ok) renderRecent(recent.rows);
      }catch(e){ /* silencioso */ }
    }

    tick();
    setInterval(tick, 4000);
  </script>
</body>
</html>
